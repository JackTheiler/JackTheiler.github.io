<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Lab 3</title>

    <!-- Leaflet CSS + JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" crossorigin=""></script>

    <!-- External GeoJSON files -->
    <script src="provinces.js"></script> 
    <script src="coviddata.js"></script>

    <!-- Fullscreen Map Styling -->
    <style>
        html, body { margin:0; padding:0; height:100%; }
        #map { min-height:100%; }
    </style>
</head>

<body>
<div id="map"></div>

<script>

//////////////////// MAP SETUP ////////////////////
var map = L.map('map', {
    center: [34.666, 104.9569],
    zoom: 5
});

//////////////////// BASEMAPS ////////////////////
var canvas = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.{ext}', {
    attribution: 'Map tiles by Stamen & OpenStreetMap',
    subdomains: 'abcd',
    maxZoom: 20,
    ext: 'png'
}).addTo(map);

var imagery = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
    attribution: 'Map tiles by Stamen & OpenStreetMap',
    subdomains: 'abcd',
    maxZoom: 18,
    ext: 'png'
});

//////////////////// CHOROPLETH FUNCTIONS ////////////////////
function getColor(d) {
    return d > 80000000 ? '#4a1486' :
           d > 60000000 ? '#6a51a3' :
           d > 40000000 ? '#807dba' :
           d > 20000000 ? '#9e9ac8' :
                          '#cbc9e2';
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties.POP10),
        weight: 1,
        opacity: 1,
        color: 'white',
        fillOpacity: 0.7
    };
}

//////////////////// PROVINCES LAYER ////////////////////
var provincesLayer = L.geoJson(provinces, {
    style: style,
    onEachFeature: function(feature, layer) {
        layer.bindPopup("<b>" + feature.properties.NAME_PY + "</b><br>Population: " + feature.properties.POP10.toLocaleString());
    }
}).addTo(map);

//////////////////// COVID POINT LAYER ////////////////////
function covidStyle(feature) {
    return {
        radius: Math.sqrt(feature.properties.covid) * 1.5,
        fillColor: "red",
        color: "#000",
        weight: 1,
        fillOpacity: 0.7
    };
}

var covidLayer = L.geoJson(covidData, {
    pointToLayer: function(feature, latlng) {
        return L.circleMarker(latlng, covidStyle(feature));
    },
    onEachFeature: function(feature, layer) {
        layer.bindPopup("<b>" + feature.properties.Location + "</b><br>Total Cases: " + feature.properties.covid);
    }
}).addTo(map);

//////////////////// LAYER CONTROL ////////////////////
var basemaps = {
    "Light Canvas": canvas,
    "Satellite Terrain": imagery
};

var overlaymaps = {
    "China Provinces": provincesLayer,
    "COVID Cases": covidLayer
};

L.control.layers(basemaps, overlaymaps, {collapsed:false}).addTo(map);

</script>
</body>
</html>
